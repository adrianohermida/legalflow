<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LegalFlow - Software Jur√≠dico Inteligente</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { 
        font-family: system-ui; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      #root { min-height: 100vh; }
      .loading-fallback {
        display: flex; 
        align-items: center; 
        justify-content: center; 
        min-height: 100vh; 
        color: white; 
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <div class="loading-fallback">
        <div style="background: white; color: #333; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);">
          <h1 style="color: #667eea; margin-bottom: 20px;">‚ö° LegalFlow</h1>
          <p>Software Jur√≠dico Inteligente</p>
          <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; color: #1e40af;">
            Carregando aplicativo completo...
          </div>
        </div>
      </div>
    </div>

    <!-- CARREGAR O APLICATIVO REAL DO LEGALFLOW -->
    <script type="module" src="/client/App.tsx"></script>

    <script>
      // Builder.io protection com limite de tentativas
      let reloadAttempts = 0;
      const MAX_RELOAD_ATTEMPTS = 2;
      
      // Inicializar contador de sessionStorage
      try {
        const storedAttempts = sessionStorage.getItem('builderReloadAttempts');
        if (storedAttempts) {
          reloadAttempts = parseInt(storedAttempts, 10) || 0;
        }
      } catch (e) {
        console.warn('Could not read reload attempts from sessionStorage');
      }
      
      function smartBuilderProtection() {
        // N√£o executar se j√° atingimos o limite
        if (reloadAttempts >= MAX_RELOAD_ATTEMPTS) {
          console.log('üõ°Ô∏è Builder.io protection: Max reload attempts reached, stopping');
          return false;
        }
        
        const bodyText = document.body.textContent || '';
        
        // DETEC√á√ÉO ESPEC√çFICA - apenas o c√≥digo exato problem√°tico
        const exactProblematicStrings = [
          'export default function MyComponent(props) { return <></>;',
          'export default function MyComponent(props) {\n  return <></>;\\n}'
        ];
        
        let hasExactProblem = false;
        for (const exactString of exactProblematicStrings) {
          if (bodyText.includes(exactString)) {
            hasExactProblem = true;
            console.error('üö® EXACT Builder.io issue detected:', exactString);
            break;
          }
        }
        
        if (hasExactProblem) {
          reloadAttempts++;
          console.log(`üîÑ Builder.io protection: Reloading (attempt ${reloadAttempts}/${MAX_RELOAD_ATTEMPTS})`);
          
          // Armazenar contador
          try {
            sessionStorage.setItem('builderReloadAttempts', reloadAttempts.toString());
          } catch (e) {
            console.warn('Could not store reload attempts in sessionStorage');
          }
          
          setTimeout(() => {
            window.location.reload();
          }, 1000);
          
          return true;
        }
        
        return false;
      }
      
      // PROTE√á√ÉO APENAS EM AMBIENTES BUILDER.IO/FLY.DEV
      const isBuilderEnv = window.location.hostname.includes('builder.codes') || 
                           window.location.hostname.includes('fly.dev') ||
                           window.location.hostname.includes('builder.io');
      
      if (isBuilderEnv && reloadAttempts < MAX_RELOAD_ATTEMPTS) {
        console.log('üèóÔ∏è Production environment detected - smart protection active');
        
        // Executar verifica√ß√£o apenas uma vez ap√≥s delay
        setTimeout(() => {
          if (!smartBuilderProtection()) {
            console.log('‚úÖ Builder.io protection: No issues detected');
            
            // Limpar contador se tudo est√° OK
            try {
              sessionStorage.removeItem('builderReloadAttempts');
            } catch (e) {
              // Ignore
            }
          }
        }, 3000); // Aguardar 3 segundos antes de verificar
      } else if (reloadAttempts >= MAX_RELOAD_ATTEMPTS) {
        console.log('üõ°Ô∏è Builder.io protection: Disabled due to max reload attempts');
      }
      
      // DETECTAR QUANDO O APLICATIVO REAL CARREGA
      setTimeout(() => {
        const reactLoaded = document.getElementById('root')?.getAttribute('data-react-loaded');
        const appStatus = document.getElementById('root')?.getAttribute('data-app-status');
        
        if (reactLoaded && appStatus) {
          console.log('‚úÖ LegalFlow real app loaded successfully');
          console.log('üì± App status:', appStatus);
          
          // Limpar contador de reloads quando app carrega com sucesso
          try {
            sessionStorage.removeItem('builderReloadAttempts');
          } catch (e) {
            // Ignore
          }
        } else {
          console.log('‚ö†Ô∏è LegalFlow app may not have loaded properly');
        }
      }, 5000);
      
      console.log('üöÄ LegalFlow - Loading real application...');
    </script>
  </body>
</html>
